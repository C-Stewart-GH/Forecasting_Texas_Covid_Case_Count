---
title: "Cameron's Book TS Project"
author: "Cameron Stewart"
date: "11/10/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

# Load Packages

```{r}
library(RCurl)
library(tswge)
library(tidyverse)
library(lubridate)
library(tseries)
```

# Bring in peak finding function

```{r}
find_peaks <- function (x, m = 3){
    shape <- diff(sign(diff(x, na.pad = FALSE)))
    pks <- sapply(which(shape < 0), FUN = function(i){
       z <- i - m + 1
       z <- ifelse(z > 0, z, 1)
       w <- i + m + 1
       w <- ifelse(w < length(x), w, length(x))
       if(all(x[c(z : i, (i + 2) : w)] <= x[i + 1])) return(i + 1) else return(numeric(0))
    })
     pks <- unlist(pks)
     pks
}
```

# Bring in rolling window ASE function

```{r}
Rolling_Window_ASE = function(series, trainingSize, horizon = 1, s = 0, d = 0, phis = 0, thetas = 0)
{
ASEHolder = numeric()

for( i in 1:(length(series)-(trainingSize + horizon) + 1))
{
  
  forecasts = fore.aruma.wge(series[i:(i+(trainingSize-1))],phi = phis, theta = thetas, s = s, d = d,n.ahead = horizon)
  
  ASE = mean((series[(trainingSize+i):(trainingSize+ i + (horizon) - 1)] - forecasts$f)^2)
         
  ASEHolder[i] = ASE

}

ASEHolder
hist(ASEHolder)
WindowedASE = mean(ASEHolder)

print("The Summary Statistics for the Rolling Window ASE Are:")
print(summary(ASEHolder))
print(paste("The Rolling Window ASE is: ",WindowedASE))
return(WindowedASE)
}
```



# Read in the data set data types

```{r}
covid <- read.csv(text=getURL("https://raw.githubusercontent.com/C-Stewart-GH/Time_Series_Project/main/Raw_Data_Files/merged_data.csv"))
covid$Date=mdy(covid$Date)
str(covid)
summary(covid)

cases=cases=read.csv(text=getURL("https://raw.githubusercontent.com/C-Stewart-GH/Time_Series_Project/main/Raw_Data_Files/Texas%20COVID-19%20Case%20Count%20Data%20by%20County.csv"))
cases$Date=mdy(cases$Date)
cases$Case.Count=c(NA,diff(cases$Case.Count))
cases=cases[2:length(cases$Date),]
str(cases)
```

# Plot reduced and full data

```{r}
plotts.sample.wge(covid$case_count,lag.max = 100,trunc = 35)
plotts.sample.wge(cases$Case.Count,lag.max = 100,trunc = 35)
```

# Create ARMA model

```{r}
acf(cases$Case.Count,lag.max = 60)
pacf(cases$Case.Count,lag.max = 60)
aic5.wge(cases$Case.Count,p = 0:33,q = 0:2)
aic5.wge(cases$Case.Count,p = 0:15,q = 0:2,type = 'bic')
aic5.wge(cases$Case.Count,p = 16:25,q = 0:2,type = 'bic')
aic5.wge(cases$Case.Count,p = 26:33,q = 0:2,type = 'bic')

#Create complex models
est_fcases_p29q1=est.arma.wge(x = cases$Case.Count,p = 29,q=1)
est_pcases_p29q1=est.arma.wge(x = covid$case_count,p = 29,q=1)

est_fcases_p30q1=est.arma.wge(x = cases$Case.Count,p = 30,q=1)
est_pcases_p30q1=est.arma.wge(x = covid$case_count,p = 30,q=1)

#Create simple models
est_fcases_p7=est.ar.wge(x = cases$Case.Count,p = 7,type = 'burg')
est_pcases_p7=est.ar.wge(x = covid$case_count,p = 7,type = 'burg')

est_fcases_p8=est.ar.wge(x = cases$Case.Count,p = 8,type = 'burg')
est_pcases_p8=est.ar.wge(x = covid$case_count,p = 8,type = 'burg')

#Identify Rolling Window ASE for short term forecast
Rolling_Window_ASE(series = cases$Case.Count,horizon = 7, phis = est_fcases_p29q1$phi,thetas = est_fcases_p29q1$theta,trainingSize = 60)
Rolling_Window_ASE(series = covid$case_count,horizon = 7, phis = est_pcases_p29q1$phi,thetas = est_pcases_p29q1$theta,trainingSize = 60)

Rolling_Window_ASE(series = cases$Case.Count,horizon = 7, phis = est_fcases_p30q1$phi,thetas = est_fcases_p30q1$theta,trainingSize = 60)
Rolling_Window_ASE(series = covid$case_count,horizon = 7, phis = est_pcases_p30q1$phi,thetas = est_pcases_p30q1$theta,trainingSize = 60)

Rolling_Window_ASE(series = cases$Case.Count,horizon = 7, phis = est_fcases_p7$phi, trainingSize = 60)
Rolling_Window_ASE(series = covid$case_count,horizon = 7, phis = est_pcases_p7$phi,trainingSize = 60)

Rolling_Window_ASE(series = cases$Case.Count,horizon = 7, phis = est_fcases_p8$phi,trainingSize = 60)
Rolling_Window_ASE(series = covid$case_count,horizon = 7, phis = est_pcases_p8$phi,trainingSize = 60)

#Identify Rolling Window ASE for long term forecast
Rolling_Window_ASE(series = cases$Case.Count,horizon = 21, phis = est_fcases_p29q1$phi,thetas = est_fcases_p29q1$theta,trainingSize = 60)
Rolling_Window_ASE(series = covid$case_count,horizon = 21, phis = est_pcases_p29q1$phi,thetas = est_pcases_p29q1$theta,trainingSize = 60)

Rolling_Window_ASE(series = cases$Case.Count,horizon = 21, phis = est_fcases_p30q1$phi,thetas = est_fcases_p30q1$theta,trainingSize = 60)
Rolling_Window_ASE(series = covid$case_count,horizon = 21, phis = est_pcases_p30q1$phi,thetas = est_pcases_p30q1$theta,trainingSize = 60)

Rolling_Window_ASE(series = cases$Case.Count,horizon = 21, phis = est_fcases_p7$phi, trainingSize = 60)
Rolling_Window_ASE(series = covid$case_count,horizon = 21, phis = est_pcases_p7$phi,trainingSize = 60)

Rolling_Window_ASE(series = cases$Case.Count,horizon = 21, phis = est_fcases_p8$phi,trainingSize = 60)
Rolling_Window_ASE(series = covid$case_count,horizon = 21, phis = est_pcases_p8$phi,trainingSize = 60)

#Put full coef of best model in partial dataset
Rolling_Window_ASE(series = covid$case_count,horizon = 7, phis = est_fcases_p30q1$phi,thetas = est_fcases_p30q1$theta,trainingSize = 60)

Rolling_Window_ASE(series = covid$case_count,horizon = 21, phis = est_fcases_p30q1$phi,thetas = est_fcases_p30q1$theta,trainingSize = 60)
```

# Create ARIMA model. Assume you remove the differencing first then seasonality then autocorrelation

```{r}
#Dicky-Fuller Test shows d=1 term in the data
adf.test(covid$case_count)
adf.test(cases$Case.Count)

#Difference data
fcases_d1=artrans.wge(covid$case_count,phi.tr = 1,lag.max = 100)
pcases_d1=artrans.wge(cases$Case.Count,phi.tr = 1,lag.max = 100)

#Verfy seasonal options. s=14, s=7, s=3.5 are most likely.
full_d1=plotts.sample.wge(fcases_d1,lag.max = 100,trunc = 35)
part_d1=plotts.sample.wge(pcases_d1,lag.max = 100,trunc = 35)

peak_index_full=find_peaks(full_d1$dbz, m = 20)
full_d1$freq[peak_index_full]
1/full_d1$freq[peak_index_full]

peak_index_part=find_peaks(part_d1$dbz, m = 20)
part_d1$freq[peak_index_part]
1/part_d1$freq[peak_index_part]

full_d1=plotts.sample.wge(covid$case_count,lag.max = 100,trunc = 300)
part_d1=plotts.sample.wge(cases$Case.Count,lag.max = 100,trunc = 300)

peak_index_full=find_peaks(full_d1$dbz, m = 10)
full_d1$freq[peak_index_full]
1/full_d1$freq[peak_index_full]

peak_index_part=find_peaks(part_d1$dbz, m = 10)
part_d1$freq[peak_index_part]
1/part_d1$freq[peak_index_part]

#Use overfit to detect seasonality. s=7 if plausible but not fully confirmed.
factor.wge(phi = c(rep(0,6),1))
est.ar.wge(fcases_d1,p = 17,type = "burg")
est.ar.wge(pcases_d1,p = 17,type = "burg")

#Remove seasonality
fcases_d1s7=artrans.wge(fcases_d1,phi.tr = c(rep(0,6),1),lag.max = 40)
pcases_d1s7=artrans.wge(pcases_d1,phi.tr = c(rep(0,6),1),lag.max = 40)

#Show there is white noise remaining (p=0 so null is rejected)
ljung.wge(fcases_d1s7,K = 24)$pval
ljung.wge(fcases_d1s7,K = 48)$pval
ljung.wge(pcases_d1s7,K = 24)$pval
ljung.wge(pcases_d1s7,K = 48)$pval

#Use aic5 to find remaining correlation
acf(fcases_d1s7,lag.max = 60)
acf(pcases_d1s7,lag.max = 60)
pacf(fcases_d1s7,lag.max = 60)
pacf(pcases_d1s7,lag.max = 60)
# aic5.wge(x = fcases_d1s7,p = 0:30,q = 0:3,type = 'aic')
# # aic5.wge(x = pcases_d1s7,p = 0:30,q = 0:3,type = 'aic')
aic5.wge(x = fcases_d1s7,p = 0:15,q = 0:3,type = 'bic')
# # aic5.wge(x = pcases_d1s7,p = 0:30,q = 0:3,type = 'bic')
# aic5.wge(x = fcases_d1s7,p = 31:37,q = 0:3,type = 'aic')
# aic5.wge(x = fcases_d1s7,p = 39:41,q = 0:3,type = 'aic')


#Estimate coefficients for model (came out exactly the same)
est_fcases_d1s7p21q1=est.arma.wge(fcases_d1s7,p = 21,q=1)
est_pcases_d1s7p21q1=est.arma.wge(pcases_d1s7,p = 21,q=1)

#Check for white noise with ARMA model
acf(artrans.wge(fcases_d1s7,phi.tr = est_fcases_d1s7p21q1$phi),lag.max = 60)
acf(artrans.wge(pcases_d1s7,phi.tr = est_pcases_d1s7p21q1$phi),lag.max = 60)
pacf(artrans.wge(fcases_d1s7,phi.tr = est_fcases_d1s7p21q1$phi),lag.max = 60)
pacf(artrans.wge(pcases_d1s7,phi.tr = est_pcases_d1s7p21q1$phi),lag.max = 60)
ljung.wge(fcases_d1s7,p = 21,q=1,K = 24)$pval
ljung.wge(fcases_d1s7,p = 21,q=1,K = 48)$pval
ljung.wge(pcases_d1s7,p = 21,q=1,K = 24)$pval
ljung.wge(pcases_d1s7,p = 21,q=1,K = 48)$pval


#Identify Rolling Window ASE for short term forecast
Rolling_Window_ASE(series = cases$Case.Count,horizon = 7,s = 7,d = 1,phis = est_fcases_d1s7p21q1$phi,thetas = est_fcases_d1s7p21q1$theta,trainingSize = 60)
Rolling_Window_ASE(series = covid$case_count,horizon = 7,s = 7,d = 1,phis = est_fcases_d1s7p21q1$phi,thetas = est_fcases_d1s7p21q1$theta,trainingSize = 60)

#Identify Rolling Window ASE for long term forecast
Rolling_Window_ASE(series = cases$Case.Count,horizon = 21,s = 7,d = 1,phis = est_fcases_d1s7p21q1$phi,thetas = est_fcases_d1s7p21q1$theta,trainingSize = 60)
Rolling_Window_ASE(series = covid$case_count,horizon = 21,s = 7,d = 1,phis = est_fcases_d1s7p21q1$phi,thetas = est_fcases_d1s7p21q1$theta,trainingSize = 60)
```

# Try out some other ARIMA models based on AIC

```{r}
#Complex Models
est_fcases_d1s7p21q1=est.arma.wge(fcases_d1s7,p = 21,q=1)
est_pcases_d1s7p21q1=est.arma.wge(pcases_d1s7,p = 21,q=1)

est_fcases_d1s7p21q2=est.arma.wge(fcases_d1s7,p = 21,q=2)
est_pcases_d1s7p21q2=est.arma.wge(pcases_d1s7,p = 21,q=2)

#Simple Models
est_fcases_d1s7p8q1=est.arma.wge(fcases_d1s7,p = 8,q=1)
est_pcases_d1s7p81q1=est.arma.wge(pcases_d1s7,p = 8,q=1)

est_fcases_d1s7p7q1=est.arma.wge(fcases_d1s7,p = 7,q=1)
est_pcases_d1s7p7q1=est.arma.wge(pcases_d1s7,p = 7,q=1)

#ACF/PACF Model
est_fcases_d1s7p42q1=est.arma.wge(fcases_d1s7,p = 42,q=1)
est_pcases_d1s7p42q1=est.arma.wge(pcases_d1s7,p = 42,q=1)

#Identify Rolling Window ASE for short term forecast
Rolling_Window_ASE(series = cases$Case.Count,horizon = 7,s = 7,d = 1,phis = est_fcases_d1s7p21q1$phi,thetas = est_fcases_d1s7p21q1$theta,trainingSize = 60)
Rolling_Window_ASE(series = covid$case_count,horizon = 7,s = 7,d = 1,phis = est_pcases_d1s7p21q1$phi,thetas = est_pcases_d1s7p21q1$theta,trainingSize = 60)

Rolling_Window_ASE(series = cases$Case.Count,horizon = 7,s = 7,d = 1,phis = est_fcases_d1s7p21q2$phi,thetas = est_fcases_d1s7p21q2$theta,trainingSize = 60)
Rolling_Window_ASE(series = covid$case_count,horizon = 7,s = 7,d = 1,phis = est_pcases_d1s7p21q2$phi,thetas = est_pcases_d1s7p21q2$theta,trainingSize = 60)

Rolling_Window_ASE(series = cases$Case.Count,horizon = 7,s = 7,d = 1,phis = est_fcases_d1s7p8q1$phi,thetas = est_fcases_d1s7p8q1$theta,trainingSize = 60)
Rolling_Window_ASE(series = covid$case_count,horizon = 7,s = 7,d = 1,phis = est_pcases_d1s7p81q1$phi,thetas = est_pcases_d1s7p81q1$theta,trainingSize = 60)

Rolling_Window_ASE(series = cases$Case.Count,horizon = 7,s = 7,d = 1,phis = est_fcases_d1s7p7q1$phi,thetas = est_fcases_d1s7p7q1$theta,trainingSize = 60)
Rolling_Window_ASE(series = covid$case_count,horizon = 7,s = 7,d = 1,phis = est_pcases_d1s7p7q1$phi,thetas = est_pcases_d1s7p7q1$theta,trainingSize = 60)

Rolling_Window_ASE(series = cases$Case.Count,horizon = 7,s = 7,d = 1,phis = est_fcases_d1s7p42q1$phi,thetas = est_fcases_d1s7p42q1$theta,trainingSize = 60)
Rolling_Window_ASE(series = covid$case_count,horizon = 7,s = 7,d = 1,phis = est_pcases_d1s7p42q1$phi,thetas = est_pcases_d1s7p42q1$theta,trainingSize = 60)

#Identify Rolling Window ASE for long term forecast
Rolling_Window_ASE(series = cases$Case.Count,horizon = 21,s = 7,d = 1,phis = est_fcases_d1s7p21q1$phi,thetas = est_fcases_d1s7p21q1$theta,trainingSize = 60)
Rolling_Window_ASE(series = covid$case_count,horizon = 21,s = 7,d = 1,phis = est_pcases_d1s7p21q1$phi,thetas = est_pcases_d1s7p21q1$theta,trainingSize = 60)

Rolling_Window_ASE(series = cases$Case.Count,horizon = 21,s = 7,d = 1,phis = est_fcases_d1s7p21q2$phi,thetas = est_fcases_d1s7p21q2$theta,trainingSize = 60)
Rolling_Window_ASE(series = covid$case_count,horizon = 21,s = 7,d = 1,phis = est_pcases_d1s7p21q2$phi,thetas = est_pcases_d1s7p21q2$theta,trainingSize = 60)

Rolling_Window_ASE(series = cases$Case.Count,horizon = 21,s = 7,d = 1,phis = est_fcases_d1s7p8q1$phi,thetas = est_fcases_d1s7p8q1$theta,trainingSize = 60)
Rolling_Window_ASE(series = covid$case_count,horizon = 21,s = 7,d = 1,phis = est_pcases_d1s7p81q1$phi,thetas = est_pcases_d1s7p81q1$theta,trainingSize = 60)

Rolling_Window_ASE(series = cases$Case.Count,horizon = 21,s = 7,d = 1,phis = est_fcases_d1s7p7q1$phi,thetas = est_fcases_d1s7p7q1$theta,trainingSize = 60)
Rolling_Window_ASE(series = covid$case_count,horizon = 21,s = 7,d = 1,phis = est_pcases_d1s7p7q1$phi,thetas = est_pcases_d1s7p7q1$theta,trainingSize = 60)

Rolling_Window_ASE(series = cases$Case.Count,horizon = 21,s = 7,d = 1,phis = est_fcases_d1s7p42q1$phi,thetas = est_fcases_d1s7p42q1$theta,trainingSize = 60)
Rolling_Window_ASE(series = covid$case_count,horizon = 21,s = 7,d = 1,phis = est_pcases_d1s7p42q1$phi,thetas = est_pcases_d1s7p42q1$theta,trainingSize = 60)

#Completing best ones
Rolling_Window_ASE(series = covid$case_count,horizon = 7,s = 7,d = 1,phis = est_fcases_d1s7p42q1$phi,thetas = est_fcases_d1s7p42q1$theta,trainingSize = 60)

Rolling_Window_ASE(series = covid$case_count,horizon = 21,s = 7,d = 1,phis = est_fcases_d1s7p42q1$phi,thetas = est_fcases_d1s7p42q1$theta,trainingSize = 60)
```

# Generate examples from models selected

```{r}
gen.aruma.wge(450,phi = est_fcases_d1s7p21q1$phi,theta =  est_fcases_d1s7p21q1$theta,d = 1,s = 7,vara = est_fcases_d1s7p21q1$avar,sn = 14)
plotts.wge(covid$case_count)
gen.aruma.wge(720,phi = est_fcases_d1s7p21q1$phi,theta =  est_fcases_d1s7p21q1$theta,d = 1,s=7,)
```


# Assume you remove seasonality first

```{r}
full=plotts.sample.wge(covid$case_count,lag.max = 100,trunc = 35)
part=plotts.sample.wge(cases$Case.Count,lag.max = 100,trunc = 35)

peak_index_full=find_peaks(full$dbz, m = 20)
full$freq[peak_index_full]
1/full$freq[peak_index_full]

peak_index_part=find_peaks(part$dbz, m = 20)
part$freq[peak_index_part]
1/part$freq[peak_index_part]

full=plotts.sample.wge(covid$case_count,lag.max = 100,trunc = 300)
part=plotts.sample.wge(cases$Case.Count,lag.max = 100,trunc = 300)

peak_index_full=find_peaks(full$dbz, m = 10)
full$freq[peak_index_full]
1/full$freq[peak_index_full]

peak_index_part=find_peaks(part$dbz, m = 10)
part$freq[peak_index_part]
1/part$freq[peak_index_part]

est.ar.wge(covid$case_count,p = ,type = "burg")
est.ar.wge(cases$Case.Count,p = 35,type = "burg")
factor.wge(phi = c(rep(0,29),1))

artrans.wge()
```

